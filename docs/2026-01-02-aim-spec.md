# aim - AI Usage Meter CLI

**Tier:** S
**Owner:** User
**Target ship:** TBD
**Links:** [QUOTA_APIS.md](../QUOTA_APIS.md) (API reference documentation)

## 1. Outcome & Scope

**Problem / context**
Users frequently work with multiple AI providers (Claude, Codex) and need to monitor usage limits to avoid hitting quotas mid-session. Currently, checking usage requires opening multiple browser dashboards or making separate API calls, which is slow and requires context-switching. There is no unified tool to see quota status at a glance.

**Change summary**
Create a Go CLI tool (`aim`) that reads OAuth credentials from standard filesystem locations and queries each provider's quota API, displaying usage percentages and reset times in a unified ASCII table.

**Scope boundary**
- Only affects this new CLI tool; no modifications to other existing files
- Read-only: does not modify credential files or call generation/inference APIs
- No token refresh in MVP; if tokens are expired, show auth error (user must refresh externally)
- Single output format (ASCII table); no JSON, CSV, or other export options
- No configuration file; credentials must exist at documented paths
- Gemini excluded from MVP (no proactive quota API available)
- Model-specific quotas (seven_day_sonnet, seven_day_opus, etc.) excluded from MVP; only main 5-hour and 7-day windows shown
- Codex code_review_rate_limit excluded from MVP; only main rate_limit windows shown

## 2. User Experience & Flows

**UX impact**
- User-visible? Yes
- When user runs `aim`, they see an ASCII table showing current usage as a percentage bar, plus when each quota window resets.

**Example output**
```
┌──────────────────────┬─────────┬─────────────┬─────────────────────┐
│ Provider             │ Window  │ Usage       │ Resets At           │
├──────────────────────┼─────────┼─────────────┼─────────────────────┤
│ Claude               │ 5-hour  │ ████░░ 24%  │ in 2h 15m           │
│ Claude               │ 7-day   │ ██████░ 36% │ Jan 8 07:00 PST     │
│ Codex (user@ex.com)  │ 5-hour  │ ░░░░░░ 3%   │ in 4h 24m           │
│ Codex (user@ex.com)  │ 7-day   │ █░░░░░ 9%   │ Jan 8 12:30 PST     │
│ Codex (work@ex.com)  │ 5-hour  │ ██░░░░ 15%  │ in 3h 10m           │
│ Codex (work@ex.com)  │ 7-day   │ ███░░░ 22%  │ Jan 7 18:00 PST     │
└──────────────────────┴─────────┴─────────────┴─────────────────────┘
```

**Warning row format**
When credentials are missing or API calls fail, a warning row spans the table:
```
│ Claude               │ ⚠ credentials not found at ~/.claude/.credentials.json     │
│ Codex (user@ex.com)  │ ⚠ API error: 401 Unauthorized                              │
```
- Provider column shows the provider name (and account identifier if known)
- Remaining columns are merged to display the warning message prefixed with ⚠

**Error scenarios**
- Missing credentials file → Show warning row with path that was checked
- Expired/invalid token → Show warning row with API error (e.g., 401 Unauthorized)
- API call fails (network, rate limit) → Show warning row with error message, continue querying other providers
- Malformed credential file → Show warning with parse error, continue with others
- All providers fail → Display table with all warning rows, exit 0 (warnings are not fatal)

## 3. Requirements + Verification

**Acceptance criteria**

Credential discovery:
- The tool resolves `~` to the user's home directory cross-platform using Go's `os.UserHomeDir()`
- Claude credentials are read from `$HOME/.claude/.credentials.json`
  - JSON structure: `{ "claudeAiOauth": { "accessToken": "...", "expiresAt": <milliseconds>, ... } }`
  - Note: `expiresAt` is in **milliseconds** (Unix epoch)
- Codex credentials are discovered by globbing `$HOME/.cli-proxy-api/codex-*.json`; all matching files are processed (supporting multiple accounts)
  - Filename format: `codex-{email}.json` where `{email}` is the literal email address (e.g., `codex-user@example.com.json`)
  - Email is extracted by stripping `codex-` prefix and `.json` suffix from the filename
  - JSON structure: `{ "access_token": "...", "refresh_token": "...", ... }`
- If a Codex file matches the glob but has an unparseable filename or missing required JSON fields, show a warning row and continue with other files

Quota display:
- When Claude credentials are valid, two rows appear (5-hour and 7-day windows) with utilization % and reset time
- When Codex credentials are valid, two rows appear per account showing 5-hour (primary) and 7-day (secondary) windows
- When any provider's credentials are missing, a warning row appears for that provider but data for other providers is still shown
- When any provider's API call fails, a warning row with error message appears but data for other providers is still shown

Time formatting:
- When reset time is <24 hours away, display in relative format (e.g., `in 2h 15m`)
- When reset time is ≥24 hours away, display as absolute timestamp in local time with timezone abbreviation (e.g., `Jan 8 07:00 PST`)
- Claude provides ISO 8601 timestamps; Codex provides Unix timestamps in seconds

Build:
- The tool is a single static Go binary with no runtime dependencies

**Regression checks**
- Tool never exits with non-zero status for missing credentials or API failures (warnings, not errors)
- No inference/generation endpoints are called
- Credential files are never modified (read-only)

## 4. Instrumentation & Release Checks

**Validation after release**

- How to confirm:
  1. Run `aim` with valid credentials for Claude and Codex
  2. Compare displayed percentages against provider dashboards
  3. Verify reset times match dashboard estimates (accounting for timezone)
  4. Remove one credential file and confirm warning appears without blocking other providers
  5. Test with expired tokens and confirm auth error is displayed
  6. Test with multiple Codex accounts and confirm all appear in output

- Known risks:
  - Provider API endpoints may change format or authentication requirements
  - Credential file locations may vary across OS or user configurations
  - Network failures could make all providers unreachable simultaneously

**Open questions**

- Future flags: Should `--json` output format be supported in a later version? (Not in MVP)
- Continuous monitoring: Should `--watch` flag for live updates be added? (Not in MVP)
- Credential path overrides: Should env vars or flags allow custom credential paths? (Not in MVP)
- Token refresh: Should the tool auto-refresh expired tokens in a future version? (Not in MVP)
