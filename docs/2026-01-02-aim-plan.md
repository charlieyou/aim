# Implementation Plan: aim CLI Tool

## Context & Goals
- **Spec**: [docs/2026-01-02-aim-spec.md](./2026-01-02-aim-spec.md)
- Build a Go CLI tool (`aim`) that displays API quota usage from Claude, Codex, and Gemini
- Output: ASCII table with provider names, usage percentages (with bars), and reset times
- Target users: Developers who use multiple AI APIs and want a unified quota view

## Scope & Non-Goals
- **In Scope**
  - Single Go binary (`aim`)
  - Claude OAuth quota API integration (5-hour + 7-day windows)
  - Codex quota API integration (multiple accounts supported)
  - Gemini quota API integration (per-model buckets with remainingFraction)
    - **Note**: Spec originally excluded Gemini ("no proactive quota API"). QUOTA_APIS.md was updated to document the `retrieveUserQuota` endpoint. User approved expanding scope to include Gemini.
  - ASCII table output with percentage bars
  - Warning rows for missing credentials or API failures
  - Relative time format (<24h) and absolute time format (>=24h)

- **Out of Scope (Non-Goals)**
  - Token refresh (user must refresh externally)
  - JSON/CSV export formats
  - Configuration file support
  - Model-specific quotas for Claude (seven_day_sonnet, seven_day_opus)
  - Codex code_review_rate_limit
  - `--watch` flag for live updates
  - Credential path overrides via env vars or flags

## Assumptions & Constraints
- Users have valid, non-expired OAuth tokens in the expected locations
- All three APIs are reachable from the user's network
- Credential files follow the documented JSON structures
- Gemini's `remainingFraction` is 0-1 scale (we convert to percentage: used = 100 - remaining*100)

### Implementation Constraints
- Single external dependency: `github.com/olekukonko/tablewriter`
- Use `net/http` stdlib for HTTP calls with **30-second timeout** per request
- Use `internal/` packages for encapsulation: `internal/providers/`, `internal/output/`
- Go 1.22+ for modern features
- No modifications to existing files (greenfield project)
- **Provider testability**: Each provider struct includes a `baseURL` field (defaults to production URL) that can be overridden in tests to point to `httptest.Server`

### Testing Constraints
- Unit tests use `httptest.Server` for HTTP mocking
- Integration tests skip gracefully when credentials don't exist (safe for CI)
- All provider implementations must be testable in isolation

## Prerequisites
- [ ] Go 1.22+ installed on development machine
- [ ] Access to test credentials for at least one provider (for integration testing)
- [ ] Understanding of each API's response format (documented in QUOTA_APIS.md)

## High-Level Approach

1. Initialize Go module with project structure (`internal/providers/`, `internal/output/`)
2. Define shared types and interfaces for providers
3. Implement each provider (Claude, Codex, Gemini) with credential loading and API calls
4. Implement output formatting (table rendering, time formatting)
5. Wire up main.go with concurrent provider queries using goroutines
6. Add unit tests with HTTP mocks
7. Add integration tests that skip without credentials

## Detailed Plan

### Task 1: Initialize Go module and project structure
- **Goal**: Create the Go module and directory structure
- **Covers**: AC: Single static Go binary
- **Depends on**: Prerequisites
- **Changes**:
  - New: `go.mod` - Initialize module (e.g., `github.com/cyou/aim`)
  - New: `go.sum` - Generated by `go mod tidy`
  - New: `internal/providers/` - Directory for provider implementations
  - New: `internal/output/` - Directory for output formatting
  - New: `main.go` - Skeleton with package main
- **Verification**:
  - `go mod tidy` succeeds
  - `go build` produces a binary (even if it does nothing yet)
- **Rollback**:
  - Delete created files and directories

### Task 2: Define shared types and provider interface
- **Goal**: Create common types used across all providers
- **Covers**: Implementation-only (foundation for all AC)
- **Depends on**: Task 1
- **Changes**:
  - New: `internal/providers/types.go`
    - `type UsageRow struct { Provider, Label string; UsagePercent float64; ResetTime time.Time; IsWarning bool; WarningMsg string }`
    - `type Provider interface { Name() string; FetchUsage(ctx context.Context) ([]UsageRow, error) }`
    - `type ProviderError struct` for structured error handling
- **Verification**:
  - `go build ./...` succeeds
  - Types are exported and usable from main package
- **Rollback**:
  - Delete `internal/providers/types.go`

### Task 3: Implement time formatting utilities
- **Goal**: Format reset times as relative (<24h) or absolute (>=24h)
- **Covers**: AC: Relative time format ("in Xh Ym"), Absolute time format ("Mon D HH:MM TZ")
- **Depends on**: Task 1
- **Changes**:
  - New: `internal/output/time.go`
    - `func FormatResetTime(t time.Time) string` - Returns "in Xh Ym" if <24h from now, else "Mon D HH:MM TZ"
    - Handle edge cases: zero time, past times
- **Verification**:
  - Unit test with times 1h, 12h, 23h59m from now -> relative format
  - Unit test with times 25h, 48h, 7d from now -> absolute format
  - Unit test with zero time -> appropriate fallback (e.g., "-")
- **Rollback**:
  - Delete `internal/output/time.go`

### Task 4: Implement table output formatting
- **Goal**: Render usage rows as ASCII table with percentage bars
- **Covers**: AC: Warning rows for missing/failed providers
- **Depends on**: Task 2, Task 3
- **Changes**:
  - New: `internal/output/table.go`
    - `func RenderTable(rows []UsageRow, w io.Writer)` - Uses tablewriter
    - Columns: Provider, Window/Model, Usage (with ASCII bar), Resets
    - ASCII bar: `[########............] 42%` style (20 chars wide)
    - Warning rows: Show provider name and warning message, no bar
  - Add dependency: `go get github.com/olekukonko/tablewriter`
- **Verification**:
  - Unit test with sample rows produces expected table format
  - Unit test with warning row shows message instead of bar
  - Visual inspection of output alignment
- **Rollback**:
  - Delete `internal/output/table.go`
  - `go mod tidy` to remove unused dependency

### Task 5: Implement Claude provider
- **Goal**: Load Claude credentials and fetch quota usage
- **Covers**: AC: Home dir via os.UserHomeDir(), Claude creds path, Claude 5-hour + 7-day rows, No inference endpoints, Creds never modified
- **Depends on**: Task 2
- **Changes**:
  - New: `internal/providers/claude.go`
    - `type ClaudeProvider struct { homeDir string; baseURL string; client *http.Client }`
    - `func NewClaudeProvider() (*ClaudeProvider, error)` - Uses `os.UserHomeDir()`, sets 30s timeout on client
    - `func (c *ClaudeProvider) loadCredentials() (token string, err error)` - Reads `~/.claude/.credentials.json`
    - `func (c *ClaudeProvider) FetchUsage(ctx context.Context) ([]UsageRow, error)`
      - GET `{baseURL}/api/oauth/usage` (baseURL defaults to `https://api.anthropic.com`)
      - Headers: `Authorization: Bearer {token}`, `anthropic-beta: oauth-2025-04-20`
      - Parse `five_hour.utilization`, `five_hour.resets_at`, `seven_day.*`
      - Return 2 rows: "5-hour" and "7-day"
- **Verification**:
  - Unit test with `httptest.Server`: set `baseURL` to test server URL
  - Unit test with mock server returning sample JSON -> correct UsageRow values
  - Unit test with missing creds file -> returns warning row
  - Unit test with invalid JSON -> returns warning row
  - Verify no POST/PUT calls in implementation
- **Rollback**:
  - Delete `internal/providers/claude.go`

### Task 6: Implement Codex provider
- **Goal**: Load Codex credentials (multiple accounts) and fetch quota usage
- **Covers**: AC: Home dir via os.UserHomeDir(), Codex glob pattern, Codex per-account rows, No inference endpoints, Creds never modified
- **Depends on**: Task 2
- **Changes**:
  - New: `internal/providers/codex.go`
    - `type CodexProvider struct { homeDir string; baseURL string; client *http.Client }`
    - `func NewCodexProvider() (*CodexProvider, error)` - Sets 30s timeout on client
    - `func (c *CodexProvider) loadCredentials() ([]CodexAccount, error)` - Globs `~/.cli-proxy-api/codex-*.json`, extracts email from filename
    - `func (c *CodexProvider) FetchUsage(ctx context.Context) ([]UsageRow, error)`
      - For each account: GET `{baseURL}/backend-api/wham/usage` (baseURL defaults to `https://chatgpt.com`)
      - Headers: `Authorization: Bearer {token}`
      - **Window mapping**:
        - `rate_limit.primary_window` → "5-hour" row (`used_percent`, `reset_at` Unix seconds)
        - `rate_limit.secondary_window` → "7-day" row (`used_percent`, `reset_at` Unix seconds)
      - Return 2 rows per account labeled "Codex (email)"
- **Verification**:
  - Unit test with `httptest.Server`: set `baseURL` to test server URL
  - Unit test with mock server -> correct rows per account
  - Unit test with multiple credential files -> multiple account rows
  - Unit test with no matching files -> returns warning row
  - Verify reset_at correctly converted from Unix seconds to time.Time
- **Rollback**:
  - Delete `internal/providers/codex.go`

### Task 7: Implement Gemini provider
- **Goal**: Load Gemini credentials (multiple accounts) and fetch per-model quota usage
- **Covers**: AC: Home dir via os.UserHomeDir(), Gemini creds paths, Gemini per-model rows, No inference endpoints, Creds never modified
- **Depends on**: Task 2
- **Changes**:
  - New: `internal/providers/gemini.go`
    - `type GeminiProvider struct { homeDir string; baseURL string; client *http.Client }`
    - `func NewGeminiProvider() (*GeminiProvider, error)` - Sets 30s timeout on client
    - `func (g *GeminiProvider) loadCredentials() ([]GeminiAccount, error)`
      - **Only use** `~/.cli-proxy-api/*-*.json` files that contain both `token.access_token` and `project_id` fields
      - Skip `~/.gemini/oauth_creds.json` (lacks required `project_id`)
      - Extract email from filename: `{email}-{project_id}.json` -> strip `-{project_id}.json` suffix
      - Process **all matching files** (multiple accounts supported, like Codex)
    - `func (g *GeminiProvider) FetchUsage(ctx context.Context) ([]UsageRow, error)`
      - For each account: POST `{baseURL}/v1internal:retrieveUserQuota` (baseURL defaults to `https://cloudcode-pa.googleapis.com`)
      - Headers: `Authorization: Bearer {token}`, `Content-Type: application/json`
      - Body: `{"project": "{project_id}"}`
      - Parse `buckets[].remainingFraction` (convert 0-1 -> 0-100% used), `buckets[].resetTime`, `buckets[].modelId`
      - Return rows labeled "Gemini (email)" with model in Label column
      - Note: `remainingFraction: 0.75` means 25% used (100 - 75*100 = 25)
- **Verification**:
  - Unit test: `remainingFraction: 0.75` -> `UsagePercent: 25`
  - Unit test with multiple buckets -> multiple rows per account
  - Unit test with multiple credential files -> rows for each account
  - Unit test with no matching files -> returns warning row
  - Unit test with file missing `project_id` field -> skipped with warning
- **Rollback**:
  - Delete `internal/providers/gemini.go`

### Task 8: Wire up main.go with concurrent execution
- **Goal**: Query all providers in parallel and render combined output
- **Covers**: AC: Exit 0 on failures, Warnings not errors
- **Depends on**: Tasks 4, 5, 6, 7
- **Changes**:
  - Update: `main.go`
    - **Constructor error handling**: If `NewXProvider()` returns an error (e.g., `os.UserHomeDir()` fails), create a warning `UsageRow` for that provider and skip fetching. Do not exit early or drop the provider silently.
    - Create all three providers; collect constructor errors as warning rows
    - Use `sync.WaitGroup` and goroutines to call `FetchUsage` concurrently (only for successfully constructed providers)
    - Collect results with mutex or channel
    - **Sort order**:
      1. Primary: Provider order (Claude, Codex, Gemini)
      2. Secondary: Alphabetical by account email/model ID within each provider
      3. Tertiary: Warnings last within each group
    - Call `output.RenderTable(rows, os.Stdout)`
    - Always `os.Exit(0)` (warnings are informational, not errors)
- **Verification**:
  - Manual test with real credentials -> table output
  - Verify concurrent execution (add timing logs, should complete in ~max(API latencies) not sum)
  - Verify exit code is 0 even when providers fail
  - Verify exit code is 0 even when provider constructors fail
  - Build static binary: `go build -o aim .`
- **Rollback**:
  - Revert main.go to skeleton

### Task 9: Add unit tests for all packages
- **Goal**: Comprehensive unit test coverage with mocked HTTP
- **Covers**: All AC (verification layer)
- **Depends on**: Tasks 3-7
- **Changes**:
  - New: `internal/output/time_test.go` - Tests for FormatResetTime
  - New: `internal/output/table_test.go` - Tests for RenderTable
  - New: `internal/providers/claude_test.go` - Tests with httptest.Server
  - New: `internal/providers/codex_test.go` - Tests with httptest.Server
  - New: `internal/providers/gemini_test.go` - Tests with httptest.Server
  - Test cases:
    - Happy path with valid responses
    - Missing credential files
    - Invalid JSON responses
    - HTTP errors (500, timeout)
    - Edge cases (zero values, empty arrays)
- **Verification**:
  - `go test ./...` passes
  - `go test -cover ./...` shows reasonable coverage
- **Rollback**:
  - Delete `*_test.go` files

### Task 10: Add integration tests
- **Goal**: Tests that hit real APIs when credentials exist
- **Covers**: All AC (end-to-end verification)
- **Depends on**: Task 8
- **Changes**:
  - New: `integration_test.go` (in root, with build tag)
    - Use `//go:build integration` tag
    - Skip individual provider tests if credentials don't exist
    - `TestClaudeIntegration` - Real API call if `~/.claude/.credentials.json` exists
    - `TestCodexIntegration` - Real API call if `~/.cli-proxy-api/codex-*.json` exists
    - `TestGeminiIntegration` - Real API call if Gemini creds exist
    - `TestFullRun` - Run main logic, verify table output
- **Verification**:
  - `go test -tags=integration ./...` passes (skips gracefully without creds)
  - Manual run on machine with credentials shows real data
- **Rollback**:
  - Delete `integration_test.go`

### Task 11 (follow-up): Add README and usage documentation
- **Goal**: Document installation and usage
- **Covers**: Implementation-only (user experience)
- **Depends on**: Task 8
- **Changes**:
  - New: `README.md`
    - Installation: `go install github.com/cyou/aim@latest`
    - Usage: `aim` (no arguments)
    - Credential locations for each provider
    - Sample output
- **Verification**:
  - README renders correctly on GitHub
  - Installation instructions work
- **Rollback**:
  - Delete `README.md`

## Risks, Edge Cases & Breaking Changes

### Edge Cases & Failure Modes

| Scenario | Handling |
|----------|----------|
| Missing credential file | Warning row: "Claude: credentials not found at ~/.claude/.credentials.json" |
| Expired token (HTTP 401) | Warning row: "Claude: authentication failed (token may be expired)" |
| Network timeout | Warning row: "Claude: request timed out" |
| Invalid JSON in creds | Warning row: "Claude: invalid credentials file format" |
| API returns unexpected structure | Warning row: "Claude: unexpected API response format" |
| All providers fail | Table with only warning rows; exit 0 |
| Gemini remainingFraction > 1 | Clamp to 100% (defensive) |
| Gemini empty buckets array | Warning row: "Gemini: no quota buckets returned" |
| Codex multiple accounts, some fail | Show successful accounts + warning rows for failed |
| Reset time in the past | Show "expired" or actual time (informational) |
| Gemini cred file missing project_id | Skip file with warning, continue with other files |
| Provider constructor fails | Warning row for that provider, continue with others |

### Breaking Changes & Compatibility
- **Potential Breaking Changes**: N/A (greenfield project)
- **Mitigations**: N/A
- **Rollout Strategy**: Initial release; users opt-in by installing

## Testing & Validation

- **Unit Tests**
  - `internal/output/time_test.go`: FormatResetTime edge cases (relative, absolute, zero, past)
  - `internal/output/table_test.go`: Table rendering, warning rows, ASCII bar generation
  - `internal/providers/*_test.go`: Each provider with mocked HTTP responses

- **Integration Tests**
  - Real API calls with `//go:build integration` tag
  - Skip gracefully when credentials don't exist
  - Verify actual response parsing works

- **Manual Verification**
  - Run `aim` on machine with real credentials
  - Verify table alignment and readability
  - Verify relative/absolute time formatting

- **Monitoring / Observability**
  - N/A for CLI tool (no persistent runtime)

### Acceptance Criteria Coverage
| Spec AC | Covered By |
|---------|------------|
| Home directory resolution via `os.UserHomeDir()` | Tasks 5, 6, 7 |
| Claude credentials from `~/.claude/.credentials.json` | Task 5, claude_test.go |
| Codex credentials via glob `~/.cli-proxy-api/codex-*.json` | Task 6, codex_test.go |
| Gemini credentials from `~/.cli-proxy-api/*-*.json` (with project_id) | Task 7, gemini_test.go |
| Claude 5-hour + 7-day rows | Task 5, claude_test.go |
| Codex 5-hour + 7-day per account | Task 6, codex_test.go |
| Gemini per-model rows with remaining % and reset time | Task 7, gemini_test.go |
| Warning rows for missing/failed providers | Tasks 4-7, table_test.go |
| Relative time format (<24h): "in Xh Ym" | Task 3, time_test.go |
| Absolute time format (>=24h): "Mon D HH:MM TZ" | Task 3, time_test.go |
| Single static Go binary | Task 1, Task 8 verification |
| Exit 0 even on failures (warnings not errors) | Task 8, integration_test.go |
| No inference/generation endpoints called | Tasks 5-7 (code review) |
| Credentials never modified | Tasks 5-7 (code review) |

## Rollback Strategy (Plan-Level)

Since this is a greenfield CLI tool:
- **Rollback**: Users uninstall: `rm $(which aim)` or `go clean -i github.com/cyou/aim`
- **Verification**: `which aim` returns nothing
- **Data cleanup**: None required (tool is read-only, stores no state)

For development rollback:
- `git reset --hard` to previous commit
- Or delete all new files and `go mod tidy`

## Open Questions

1. **Module path**: What should the Go module path be? (e.g., `github.com/cyou/aim` or another path) - Affects Task 1

2. **CI/CD setup**: Is there a preference for CI configuration (GitHub Actions, etc.) or should this be deferred? - Does not block MVP
