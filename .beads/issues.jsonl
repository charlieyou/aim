{"id":"ai-meter-11v","title":"Epic: aim CLI Tool - AI Usage Meter","description":"# aim CLI Tool Implementation\n\nBuild a Go CLI tool that queries Claude, Codex, and Gemini quota APIs and displays usage in a unified ASCII table.\n\n## Spec\n- [docs/2026-01-02-aim-spec.md](docs/2026-01-02-aim-spec.md)\n- [docs/2026-01-02-aim-plan.md](docs/2026-01-02-aim-plan.md)\n\n## Key Requirements\n- Single static Go binary with no runtime dependencies\n- Read OAuth credentials from standard filesystem locations\n- Display usage percentages with ASCII bars and reset times\n- Graceful error handling (warnings, not failures)\n- Always exit 0\n\n## Architecture\n- `internal/providers/` - Provider implementations (Claude, Codex, Gemini)\n- `internal/output/` - Table rendering and time formatting\n- `main.go` - Orchestration with concurrent provider queries\n\n## Child Issues\nSee linked issues for implementation breakdown.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-02T19:38:49.714148292Z","created_by":"cyou","updated_at":"2026-01-02T19:38:49.714148292Z"}
{"id":"ai-meter-11v.1","title":"Foundation: Go module setup and shared types","description":"## Context\n- First task for aim CLI - establishes project structure and shared types\n- All other tasks depend on this foundation\n- Combines Plan Tasks 1 and 2 for efficiency\n\n## Scope\n**In:** Initialize Go module, create directory structure, define shared types and interfaces\n**Out:** Provider implementations, output formatting, tests\n\n## Primary Files\n- `go.mod` (new)\n- `main.go` (new - skeleton only)\n- `internal/providers/types.go` (new)\n\n## Implementation Details\n\n### go.mod\n```\nmodule github.com/cyou/aim\n\ngo 1.22\n```\n\n### main.go (skeleton)\n```go\npackage main\n\nfunc main() {\n    // TODO: Wire up providers and output\n}\n```\n\n### internal/providers/types.go\n```go\npackage providers\n\nimport (\n    \"context\"\n    \"time\"\n)\n\n// UsageRow represents a single row in the output table\ntype UsageRow struct {\n    Provider     string    // e.g., \"Claude\", \"Codex (user@example.com)\", \"Gemini (user@example.com)\"\n    Label        string    // e.g., \"5-hour\", \"7-day\", \"gemini-2.5-pro\"\n    UsagePercent float64   // 0-100\n    ResetTime    time.Time // When quota resets\n    IsWarning    bool      // If true, this is a warning row\n    WarningMsg   string    // Warning message (only if IsWarning)\n}\n\n// Provider defines the interface all quota providers must implement\ntype Provider interface {\n    Name() string\n    FetchUsage(ctx context.Context) ([]UsageRow, error)\n}\n\n// ProviderError wraps errors with provider context\ntype ProviderError struct {\n    Provider string\n    Message  string\n    Err      error\n}\n\nfunc (e *ProviderError) Error() string {\n    if e.Err != nil {\n        return e.Provider + \": \" + e.Message + \": \" + e.Err.Error()\n    }\n    return e.Provider + \": \" + e.Message\n}\n```\n\n## Acceptance Criteria\n- [ ] `go mod tidy` succeeds without errors\n- [ ] `go build ./...` succeeds\n- [ ] `internal/providers/types.go` exports `UsageRow`, `Provider`, and `ProviderError`\n- [ ] Types compile and can be imported from main package\n\n## Test Plan\n- Run `go build ./...` to verify compilation\n- No unit tests needed for this task (types only)\n\n## Notes for Agent\n- Use Go 1.22+ as specified in plan\n- Keep main.go minimal - just package declaration and empty main()\n- Create directories: `internal/providers/`, `internal/output/`","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-01-02T19:39:06.76779302Z","created_by":"cyou","updated_at":"2026-01-02T19:39:30.318794246Z","dependencies":[{"issue_id":"ai-meter-11v.1","depends_on_id":"ai-meter-11v","type":"parent-child","created_at":"2026-01-02T19:39:06.774448628Z","created_by":"daemon"}]}
{"id":"ai-meter-11v.2","title":"Time formatting utilities with unit tests","description":"## Context\n- Formats reset times for display in the quota table\n- Relative format (\u003c24h): \"in 2h 15m\"\n- Absolute format (\u003e=24h): \"Jan 8 07:00 PST\"\n- Plan Task 3\n\n## Scope\n**In:** FormatResetTime function with edge case handling, unit tests\n**Out:** Table rendering, provider implementations\n\n## Primary Files\n- `internal/output/time.go` (new)\n- `internal/output/time_test.go` (new)\n\n## Implementation Details\n\n### internal/output/time.go\n```go\npackage output\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\n// FormatResetTime formats a reset time for display.\n// - If \u003c24h from now: \"in Xh Ym\" (relative)\n// - If \u003e=24h from now: \"Mon D HH:MM TZ\" (absolute in local time)\n// - If zero time: \"-\"\n// - If in the past: \"expired\" or the actual time\nfunc FormatResetTime(t time.Time) string {\n    if t.IsZero() {\n        return \"-\"\n    }\n    \n    now := time.Now()\n    diff := t.Sub(now)\n    \n    if diff \u003c= 0 {\n        return \"expired\"\n    }\n    \n    if diff \u003c 24*time.Hour {\n        hours := int(diff.Hours())\n        minutes := int(diff.Minutes()) % 60\n        if hours \u003e 0 {\n            return fmt.Sprintf(\"in %dh %dm\", hours, minutes)\n        }\n        return fmt.Sprintf(\"in %dm\", minutes)\n    }\n    \n    // Use local timezone\n    local := t.Local()\n    return local.Format(\"Jan 2 15:04 MST\")\n}\n```\n\n## Acceptance Criteria\n- [ ] `FormatResetTime` returns \"in Xh Ym\" for times 1h, 12h, 23h59m from now\n- [ ] `FormatResetTime` returns \"Mon D HH:MM TZ\" for times 25h, 48h, 7d from now\n- [ ] `FormatResetTime` returns \"-\" for zero time\n- [ ] `FormatResetTime` returns \"expired\" for past times\n- [ ] All unit tests pass\n\n## Test Plan (TDD)\n1. Write failing tests first for each case:\n   - Relative: 1h, 2h15m, 12h, 23h59m from now\n   - Absolute: 25h, 48h, 7d from now\n   - Edge: zero time, past time (1h ago)\n2. Implement FormatResetTime\n3. Verify all tests pass\n\n### Test Cases\n```go\nfunc TestFormatResetTime_Relative(t *testing.T) {\n    // 2h 15m from now -\u003e \"in 2h 15m\"\n}\n\nfunc TestFormatResetTime_Absolute(t *testing.T) {\n    // 25h from now -\u003e \"Jan X HH:MM TZ\"\n}\n\nfunc TestFormatResetTime_Zero(t *testing.T) {\n    // time.Time{} -\u003e \"-\"\n}\n\nfunc TestFormatResetTime_Past(t *testing.T) {\n    // 1h ago -\u003e \"expired\"\n}\n```\n\n## Notes for Agent\n- Use table-driven tests for cleaner test code\n- Be careful with timezone handling in tests - use fixed offsets or mock time.Now()\n- The 24h boundary is inclusive on the absolute side (\u003e=24h uses absolute format)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T19:39:31.696399019Z","created_by":"cyou","updated_at":"2026-01-02T19:39:31.696399019Z","dependencies":[{"issue_id":"ai-meter-11v.2","depends_on_id":"ai-meter-11v","type":"parent-child","created_at":"2026-01-02T19:39:31.703325424Z","created_by":"daemon"}]}
{"id":"ai-meter-11v.3","title":"Claude provider implementation with unit tests","description":"## Context\n- Implements Claude OAuth quota API integration\n- Reads credentials from ~/.claude/.credentials.json\n- Returns 5-hour and 7-day usage rows\n- Plan Task 5\n\n## Scope\n**In:** ClaudeProvider struct, credential loading, API calls, unit tests with httptest\n**Out:** Other providers, main orchestration\n\n## Primary Files\n- `internal/providers/claude.go` (new)\n- `internal/providers/claude_test.go` (new)\n\n## API Details (from QUOTA_APIS.md)\n\n### Endpoint\n```\nGET https://api.anthropic.com/api/oauth/usage\n```\n\n### Headers\n```\nAuthorization: Bearer {accessToken}\nAccept: application/json\nanthropic-beta: oauth-2025-04-20\n```\n\n### Response\n```json\n{\n  \"five_hour\": {\n    \"utilization\": 24.0,\n    \"resets_at\": \"2026-01-02T19:59:59.600956+00:00\"\n  },\n  \"seven_day\": {\n    \"utilization\": 36.0,\n    \"resets_at\": \"2026-01-08T06:59:59.600974+00:00\"\n  }\n}\n```\n\n### Credentials (~/.claude/.credentials.json)\n```json\n{\n  \"claudeAiOauth\": {\n    \"accessToken\": \"...\",\n    \"expiresAt\": 1767396165210\n  }\n}\n```\nNote: expiresAt is in **milliseconds**\n\n## Implementation Details\n\n```go\ntype ClaudeProvider struct {\n    homeDir string\n    baseURL string        // For testing - defaults to https://api.anthropic.com\n    client  *http.Client  // With 30s timeout\n}\n\nfunc NewClaudeProvider() (*ClaudeProvider, error)\nfunc (c *ClaudeProvider) Name() string // returns \"Claude\"\nfunc (c *ClaudeProvider) FetchUsage(ctx context.Context) ([]UsageRow, error)\nfunc (c *ClaudeProvider) loadCredentials() (token string, err error)\n```\n\n## Acceptance Criteria\n- [ ] Reads credentials from ~/.claude/.credentials.json\n- [ ] Parses accessToken from claudeAiOauth.accessToken\n- [ ] Makes GET request with correct headers including anthropic-beta\n- [ ] Returns 2 UsageRow structs (5-hour and 7-day)\n- [ ] Parses ISO 8601 timestamps correctly\n- [ ] Returns warning row if credentials file missing\n- [ ] Returns warning row if credentials file malformed\n- [ ] Returns warning row if API returns error (401, 500, etc.)\n- [ ] Uses 30s HTTP timeout\n- [ ] baseURL is configurable for testing\n- [ ] All unit tests pass\n\n## Test Plan (TDD)\n1. Write failing test for happy path with mock server\n2. Implement basic credential loading and API call\n3. Write failing test for missing credentials\n4. Add error handling\n5. Write failing test for API errors\n6. Add API error handling\n\n### Test Cases\n```go\nfunc TestClaudeProvider_FetchUsage_Success(t *testing.T) {\n    // Mock server returns valid JSON -\u003e 2 correct UsageRows\n}\n\nfunc TestClaudeProvider_FetchUsage_MissingCreds(t *testing.T) {\n    // No creds file -\u003e warning row with path\n}\n\nfunc TestClaudeProvider_FetchUsage_MalformedCreds(t *testing.T) {\n    // Invalid JSON -\u003e warning row\n}\n\nfunc TestClaudeProvider_FetchUsage_APIError(t *testing.T) {\n    // 401 response -\u003e warning row with error\n}\n```\n\n## Notes for Agent\n- Use httptest.Server and set provider.baseURL to test server URL\n- Parse resets_at as RFC3339 (ISO 8601)\n- Read-only: never modify credential files\n- Never call inference/generation endpoints","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T19:39:55.490535163Z","created_by":"cyou","updated_at":"2026-01-02T19:39:55.490535163Z","dependencies":[{"issue_id":"ai-meter-11v.3","depends_on_id":"ai-meter-11v","type":"parent-child","created_at":"2026-01-02T19:39:55.491009169Z","created_by":"daemon"}]}
